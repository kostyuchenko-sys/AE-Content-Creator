# Epic: AE Template Constructor

**Status**: active  
**Owner**: AI + Vlad  
**Scope**: Расширение (extension) для After Effects, которое позволяет выбирать шаблоны, подставлять футажи в подготовленные плейсхолдеры в AE-проектах и собирать итоговую композицию как конструктор.

Связанные эпики/документы:

- `epic/project-log.md` — общий лог проекта (фиксируем ключевые решения и вехи).

---

## Tech Plan (for this epic)

### 1. Архитектура решения

- **Extension-панель** в After Effects:
  - Современный вариант — UXP-панель (для свежих версий AE).
- **UI-панель конструктора**:
  - Список доступных **шаблонов** (пресеты / AE-проекты / precomp’ы).
  - Зона для выбора или перетаскивания **футажей** (drag & drop из файловой системы или из Project панели AE).
  - Кнопка(и) **"Apply template" / "Build"**, чтобы запустить скрипт замены плейсхолдеров и сборки композиции.
- **Скриптовый слой (ExtendScript / AE scripting API)**:
  - Открытие/подключение нужного шаблонного AE-проекта (если он отдельный).
  - Поиск плейсхолдеров (по имени/label/marker’ам).
  - Замена источников в слоях (footage, comps, text).
  - Добавление итоговой композиции в **активную композицию** или создание новой.
- **Конфигурация шаблонов**:
  - Для каждого шаблона — JSON/JS-конфиг с описанием:
    - Идентификатор шаблона.
    - Какой проект/comp использовать как основу.
    - Какие плейсхолдеры есть (видео, изображения, текст) и как их матчить с входными футажами.

### 2. Основные сценарии использования

1. **Выбор шаблона**:
   - Пользователь видит список шаблонов в панели, выбирает один.
2. **Выбор/перетаскивание футажей**:
   - Вариант A: drag & drop файлов из Finder в панель → расширение импортирует их в AE.
   - Вариант B: выбор уже импортированных футажей из Project-панели (через скрипт, по выделению).
3. **Запуск скрипта сборки**:
   - Нажатие на кнопку `Build / Apply`.
   - Скрипт находит плейсхолдеры в шаблоне и сопоставляет их с футажами (по порядку или по метаданным).
   - Создается итоговая композиция, которая:
     - либо добавляется как слой в **активную композицию**,
     - либо создается как отдельная финальная comp.
4. **Конструктор**:
   - Пользователь может несколько раз запускать разные шаблоны и собирать их в одну большую композицию.
   - Возможность "preset-пакетов" (наборов шаблонов для сценариев типа stories, reels и т.п.).

### 3. Тестируемые шаги (итеративный план)

1. **PoC: минимальный скрипт замены плейсхолдеров**
   - [ ] Создать тестовый AE-проект с:
     - [ ] Одной comp-шаблоном с 2–3 плейсхолдерами видео (`PH_1`, `PH_2`, `PH_3`).
   - [x] Написать ExtendScript/JSX-скрипт, который:
     - [x] Берет выделенные футажи в Project-панели.
     - [x] По списку подставляет их в слои `PH_1..3` (замена `source` у FootageLayer).
     - [x] Создает дубликат comp с подставленными футажами.
     - [x] Делает новую композицию активной.
   - **Критерий готовности**: скрипт (`ae-scripts/replace_placeholders_poc.jsx`) запускается из меню/скрипт-панели AE и корректно заменяет плейсхолдеры.

2. **Базовая панель-расширение (extension)**
   - [x] Поднять минимальный extension:
     - [x] Выбрать стек: на первом этапе используем CEP-панель (HTML/JS + ExtendScript).
     - [x] Показать простое окно с кнопкой `Build from selection`.
     - [x] Исправить манифест (Version 9.0, CSXS 9.0, пути `./index.html`, `./host.js`).
     - [x] Добавить CSInterface.js библиотеку для работы CEP.
     - [x] Включить PlayerDebugMode для неподписанных расширений (CSXS.11/12/13).
   - [x] Связать кнопку панели с PoC-скриптом:
     - [x] Нажатие в панели запускает тот же процесс замены плейсхолдеров.
   - **Критерий готовности**: ✅ панель появляется в `Window → Extensions (Legacy) → AE Content Constructor` и пользователь может, не заходя в меню скриптов, нажать кнопку в панели и получить готовую композицию из `TEMPLATE_MAIN` по выделенным футажам.

3. **Система шаблонов и конфигов**
   - [x] Определить формат конфига шаблона (например, `templates/<id>.json`):
     - [x] ID шаблона, имя для UI.
     - [x] Путь к проекту/comp или имя comp в текущем проекте.
     - [x] Список плейсхолдеров (имя слоя, тип: `video|image|text`, порядок).
     - [x] Пример: `templates/basic_story.json` с `mainCompName: "TEMPLATE_MAIN"` и плейсхолдерами PH1/PH2/PH3.
   - [x] Реализовать загрузку списка шаблонов в панели:
     - [x] Чтение `.json` из подпапки `templates` рядом с CEP-расширением.
     - [x] Отображение названия шаблонов в выпадающем списке.
   - [x] На основе выбранного шаблона конфигурировать поведение скрипта:
     - [x] Передавать `mainCompName` в `runReplacePlaceholdersPoCWithCompName(...)` вместо жёсткого `TEMPLATE_MAIN`.
   - **Критерий готовности**: ✅ можно добавить новый шаблон, просто создав конфиг и AE-проект (без правок кода; копирование конфигов до CEP-папки делает post-commit hook). Панель успешно загружает шаблоны из JSON и позволяет выбирать их из выпадающего списка.

4. **Работа с футажами (drag & drop / выбор)**
   - [x] Реализовать drag & drop файлов в панель:
     - [x] Добавлена зона для перетаскивания файлов с визуальной обратной связью.
     - [x] После drop — импорт файлов в проект AE через JSX (ImportOptions).
     - [x] Автоматическое выделение импортированных элементов в Project.
     - [x] Отображение списка загруженных файлов в панели.
   - [x] Добавить режим "использовать выделенное в Project panel":
     - [x] Если в Project выделены N элементов — запускаем сборку с ними (уже работает через `getSelectedFootageItems()`).
   - [x] Определить стратегию сопоставления (mapping):
     - [x] Реализован простой режим: по индексу (`PH1/PH_1` ← первый футаж, `PH2/PH_2` ← второй и т.д.).
     - [ ] В будущем: по тегам/типам (например, `PH_INSTA_STORY`, `PH_LOGO`).
   - **Критерий готовности**: ✅ пользователь может либо перетащить файлы в панель (они автоматически импортируются и выделяются), либо выделить их в Project и собрать шаблон.

5. **Конструктор: сборка нескольких шаблонов**
   - [ ] Добавить возможность список "шагов":
     - [ ] Пользователь выбирает несколько шаблонов и настраивает для них футажи.
   - [ ] При нажатии `Build sequence`:
     - [ ] Для каждого шага создается своя comp.
     - [ ] Все они складываются в одну финальную comp (последовательно).
   - **Критерий готовности**: можно собрать последовательность из нескольких шаблонов в одну ленту.

6. **UX и отладка**
   - [x] Добавить базовый лог/статус в панели (progress, ошибки).
   - [x] Обработать типичные ошибки:
     - [x] Не хватает футажей / не заполнены слоты.
     - [x] Не найден плейсхолдер в шаблоне.
     - [x] Неверная версия AE / API (явное сообщение при отсутствии CSInterface).

### 4. Примеры кода (упрощенные)

#### 4.1. Замена источника слоя (ExtendScript)

```javascript
// Псевдокод для JSX/ExtendScript
function replacePlaceholders(compName, footageItems) {
  var proj = app.project;
  var comp = proj.item(1); // найти comp по имени/индексу
  for (var i = 1; i <= comp.numLayers; i++) {
    var layer = comp.layer(i);
    if (layer.name.indexOf("PH_") === 0 && footageItems.length > 0) {
      var footage = footageItems.shift();
      layer.replaceSource(footage, false);
    }
  }
}
```

#### 4.2. Вызов скрипта из панели (условный пример)

```javascript
// Внутри UI-панели (UXP/CEP) вызываем JSX:
function buildFromSelection() {
  // evalScript / callExtendScript("replacePlaceholdersFromSelection()");
}
```

---

## Log

- **2026-01-28** — **decision** — Определен концепт AE Template Constructor  
  - **Details**: Сформулирована архитектура (панель-расширение + скриптовый слой + конфиги шаблонов), базовые сценарии использования и поэтапный план реализации.
  - **Links**: (добавить позже: репозиторий, PRы, демо-видео).
- **2026-01-28** — **feature** — Реализован PoC-скрипт замены плейсхолдеров  
  - **Details**: Добавлен `ae-scripts/replace_placeholders_poc.jsx`, который берет выделенные футажи из Project-панели, дублирует comp-шаблон и подставляет футажи в слои-плейсхолдеры (`PH_*`), делая новую композицию активной.
  - **Links**: (добавить позже: пример проекта `.aep`, демо-видео работы PoC).
- **2026-01-28** — **feature** — Добавлена CEP-панель AE Content Constructor  
  - **Details**: Создана минимальная CEP-панель (`extension/cep/AEContentConstructor`) с кнопкой `Build from selection`, которая через `CSInterface.evalScript` вызывает `runReplacePlaceholdersPoC()` и собирает композу из шаблона `TEMPLATE_MAIN` по выделенным футажам.
  - **Links**: (добавить позже: инструкция по установке расширения в папку CEP, демо).
- **2026-01-28** — **decision** — Определён формат JSON-конфигов шаблонов  
  - **Details**: Добавлен пример `templates/basic_story.json` с полями `id`, `name`, `description`, `mainCompName` и списком `placeholders` с индексами и паттернами имён слоёв (PH1/PH2/PH3).
  - **Links**: (добавить позже: документация по формату шаблонов, UI выбора шаблонов в панели).
- **2026-01-28** — **feature** — Панель читает шаблоны из JSON-конфигов  
  - **Details**: CEP-панель загружает `.json` из папки `templates` расширения, показывает их как список в `select`, а выбранный `mainCompName` передаёт в `runReplacePlaceholdersPoCWithCompName(...)`. Post-commit hook синхронизирует `templates/` из репозитория в расширение.
  - **Links**: (добавить позже: демо выбора разных шаблонов).
- **2026-01-28** — **bugfix** — Исправлена проблема с отображением CEP-панели в AE  
  - **Details**: Обновлён манифест до Version 9.0 и CSXS 9.0, добавлена библиотека CSInterface.js, включён PlayerDebugMode для CSXS.11/12/13. Панель теперь корректно появляется в `Window → Extensions (Legacy)`.
  - **Links**: `CEP_SETUP.md` с инструкциями по установке.
- **2026-01-28** — **bugfix** — Исправлена загрузка шаблонов и выполнение JSX из панели  
  - **Details**: Улучшена обработка ошибок при чтении шаблонов через CEP FS (добавлен fallback на дефолтный шаблон), JSX-код встроен прямо в панель для прямого выполнения через `evalScript`. Панель теперь полностью функциональна: шаблоны загружаются в выпадающий список, кнопка "Build from selection" успешно создаёт композиции с заменёнными плейсхолдерами.
  - **Links**: (добавить позже: демо работы панели).
- **2026-01-28** — **feature** — Добавлен drag & drop для импорта футажей  
  - **Details**: Реализована зона для перетаскивания файлов в панель с визуальной обратной связью (подсветка при наведении). При drop файлы автоматически импортируются в AE через `ImportOptions`, выделяются в Project-панели и отображаются в списке загруженных файлов. Пользователь может работать как с drag & drop, так и с выделением в Project.
  - **Links**: (добавить позже: демо drag & drop).
- **2026-01-28** — **feature** — Добавлен Template Packer для сборки пакетов шаблонов  
  - **Details**: Добавлен `packer/template_packer.jsx` и документирован формат пакета в `packer/README.md`. Скрипт маркирует плейсхолдеры, генерирует `template.json`, рендерит `preview.mp4` и сохраняет `project.aep` в папку пакета.
  - **Links**: `packer/template_packer.jsx`, `packer/README.md`.
- **2026-01-28** — **feature** — UI шаблонов с превью и слотами  
  - **Details**: Панель перешла на карточки шаблонов (превью/описание), добавлены динамические слоты подстановки, поддержка источника шаблонов из локального репозитория (путь задаётся в UI).
  - **Links**: `extension/cep/AEContentConstructor/index.html`, `extension/cep/AEContentConstructor/host.js`.
- **2026-01-28** — **feature** — Улучшен UX ошибок и статусов панели  
  - **Details**: Добавлены статусы с типами (info/success/error), подсветка незаполненных слотов, кнопка очистки слотов и валидация перед сборкой.
  - **Links**: `extension/cep/AEContentConstructor/index.html`, `extension/cep/AEContentConstructor/host.js`.
- **2026-01-28** — **feature** — Импорт шаблона в текущий проект  
  - **Details**: Если в `template.json` указан `project.aep`, панель импортирует шаблонный проект в текущий AE‑проект, ищет `mainCompName` внутри импортированного пакета и добавляет созданную комп‑копию как слой в активную композицию.
  - **Links**: `extension/cep/AEContentConstructor/host.js`, `packer/template_packer.jsx`.

*(Новые шаги реализации и ключевые решения по этому epic добавляем сюда по мере движения.)*

---

## Status

- **Current status**: `active` — план утвержден, epic в работе. Шаги 1–4 завершены и работают.
- **Next actions**:
  - Шаг 5: Конструктор для сборки нескольких шаблонов в последовательность.
  - Шаг 6: UX улучшения и обработка ошибок.

