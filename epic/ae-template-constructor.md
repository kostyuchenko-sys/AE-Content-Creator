# Epic: AE Template Constructor

**Status**: draft  
**Owner**: AI + Vlad  
**Scope**: Расширение (extension) для After Effects, которое позволяет выбирать шаблоны, подставлять футажи в подготовленные плейсхолдеры в AE-проектах и собирать итоговую композицию как конструктор.

Связанные эпики/документы:

- `epic/project-log.md` — общий лог проекта (фиксируем ключевые решения и вехи).

---

## Tech Plan (for this epic)

### 1. Архитектура решения

- **Extension-панель** в After Effects:
  - Современный вариант — UXP-панель (для свежих версий AE).
  - Альтернативно/параллельно — CEP-панель (HTML/JS + ExtendScript), если нужен бóльший охват старых версий.
- **UI-панель конструктора**:
  - Список доступных **шаблонов** (пресеты / AE-проекты / precomp’ы).
  - Зона для выбора или перетаскивания **футажей** (drag & drop из файловой системы или из Project панели AE).
  - Кнопка(и) **"Apply template" / "Build"**, чтобы запустить скрипт замены плейсхолдеров и сборки композиции.
- **Скриптовый слой (ExtendScript / AE scripting API)**:
  - Открытие/подключение нужного шаблонного AE-проекта (если он отдельный).
  - Поиск плейсхолдеров (по имени/label/marker’ам).
  - Замена источников в слоях (footage, comps, text).
  - Добавление итоговой композиции в **активную композицию** или создание новой.
- **Конфигурация шаблонов**:
  - Для каждого шаблона — JSON/JS-конфиг с описанием:
    - Идентификатор шаблона.
    - Какой проект/comp использовать как основу.
    - Какие плейсхолдеры есть (видео, изображения, текст) и как их матчить с входными футажами.

### 2. Основные сценарии использования

1. **Выбор шаблона**:
   - Пользователь видит список шаблонов в панели, выбирает один.
2. **Выбор/перетаскивание футажей**:
   - Вариант A: drag & drop файлов из Finder в панель → расширение импортирует их в AE.
   - Вариант B: выбор уже импортированных футажей из Project-панели (через скрипт, по выделению).
3. **Запуск скрипта сборки**:
   - Нажатие на кнопку `Build / Apply`.
   - Скрипт находит плейсхолдеры в шаблоне и сопоставляет их с футажами (по порядку или по метаданным).
   - Создается итоговая композиция, которая:
     - либо добавляется как слой в **активную композицию**,
     - либо создается как отдельная финальная comp.
4. **Конструктор**:
   - Пользователь может несколько раз запускать разные шаблоны и собирать их в одну большую композицию.
   - Возможность "preset-пакетов" (наборов шаблонов для сценариев типа stories, reels и т.п.).

### 3. Тестируемые шаги (итеративный план)

1. **PoC: минимальный скрипт замены плейсхолдеров**
   - [ ] Создать тестовый AE-проект с:
     - [ ] Одной comp-шаблоном с 2–3 плейсхолдерами видео (`PH_1`, `PH_2`, `PH_3`).
   - [ ] Написать ExtendScript/JSX-скрипт, который:
     - [ ] Берет выделенные футажи в Project-панели.
     - [ ] По списку подставляет их в слои `PH_1..3` (замена `source` у FootageLayer).
     - [ ] Создает дубликат comp с подставленными футажами.
   - **Критерий готовности**: скрипт запускается из меню/скрипт-панели AE и корректно заменяет плейсхолдеры.

2. **Базовая панель-расширение (extension)**
   - [ ] Поднять минимальный extension:
     - [ ] Выбрать стек: UXP-панель (предпочтительно) или CEP.
     - [ ] Показать простое окно с кнопкой `Build from selection`.
   - [ ] Связать кнопку панели с PoC-скриптом:
     - [ ] Нажатие в панели запускает тот же процесс замены плейсхолдеров.
   - **Критерий готовности**: пользователь может, не заходя в меню скриптов, нажать кнопку в панели и получить готовую композицию.

3. **Система шаблонов и конфигов**
   - [ ] Определить формат конфига шаблона (например, `templates/<id>.json`):
     - [ ] ID шаблона, имя для UI.
     - [ ] Путь к проекту/comp или имя comp в текущем проекте.
     - [ ] Список плейсхолдеров (имя слоя, тип: `video|image|text`, порядок).
   - [ ] Реализовать загрузку списка шаблонов в панели:
     - [ ] Отображение названия + иконки/превью (по возможности).
   - [ ] На основе выбранного шаблона конфигурировать поведение скрипта.
   - **Критерий готовности**: можно добавить новый шаблон, просто создав конфиг и AE-проект (без правок кода).

4. **Работа с футажами (drag & drop / выбор)**
   - [ ] Реализовать drag & drop файлов в панель:
     - [ ] После drop — импорт файлов в проект AE (если еще не импортированы).
   - [ ] Добавить режим "использовать выделенное в Project panel":
     - [ ] Если в Project выделены N элементов — запускаем сборку с ними.
   - [ ] Определить стратегию сопоставления (mapping):
     - [ ] Простой режим: по порядку (`PH_1` ← первый футаж, и т.д.).
     - [ ] В будущем: по тегам/типам (например, `PH_INSTA_STORY`, `PH_LOGO`).
   - **Критерий готовности**: пользователь может либо перетащить файлы в панель, либо выделить их в Project и собрать шаблон.

5. **Конструктор: сборка нескольких шаблонов**
   - [ ] Добавить возможность список "шагов":
     - [ ] Пользователь выбирает несколько шаблонов и настраивает для них футажи.
   - [ ] При нажатии `Build sequence`:
     - [ ] Для каждого шага создается своя comp.
     - [ ] Все они складываются в одну финальную comp (последовательно).
   - **Критерий готовности**: можно собрать последовательность из нескольких шаблонов в одну ленту.

6. **UX и отладка**
   - [ ] Добавить базовый лог/статус в панели (progress, ошибки).
   - [ ] Обработать типичные ошибки:
     - [ ] Не хватает футажей.
     - [ ] Не найден плейсхолдер в шаблоне.
     - [ ] Неверная версия AE / API.

### 4. Примеры кода (упрощенные)

#### 4.1. Замена источника слоя (ExtendScript)

```javascript
// Псевдокод для JSX/ExtendScript
function replacePlaceholders(compName, footageItems) {
  var proj = app.project;
  var comp = proj.item(1); // найти comp по имени/индексу
  for (var i = 1; i <= comp.numLayers; i++) {
    var layer = comp.layer(i);
    if (layer.name.indexOf("PH_") === 0 && footageItems.length > 0) {
      var footage = footageItems.shift();
      layer.replaceSource(footage, false);
    }
  }
}
```

#### 4.2. Вызов скрипта из панели (условный пример)

```javascript
// Внутри UI-панели (UXP/CEP) вызываем JSX:
function buildFromSelection() {
  // evalScript / callExtendScript("replacePlaceholdersFromSelection()");
}
```

---

## Log

- **2026-01-28** — **decision** — Определен концепт AE Template Constructor  
  - **Details**: Сформулирована архитектура (панель-расширение + скриптовый слой + конфиги шаблонов), базовые сценарии использования и поэтапный план реализации.
  - **Links**: (добавить позже: репозиторий, PRы, демо-видео).

*(Новые шаги реализации и ключевые решения по этому epic добавляем сюда по мере движения.)*

---

## Status

- **Current status**: `draft` — концепт и план определены, требуется твое подтверждение и приоритизация этапов (1–6).
- **Next actions**:
  - Уточнить целевую версию(и) After Effects (важно для выбора UXP vs CEP).
  - Выбрать, с какого шага начинаем (я предлагаю PoC — шаг 1).
  - После начала реализации переводим статус в `active` и начинаем фиксировать прогресс в `Log`.

